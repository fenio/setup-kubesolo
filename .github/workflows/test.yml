name: Test Setup KubeSolo Action

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  test-kubesolo:
    runs-on: ubuntu-latest
    name: Test KubeSolo Installation and Functionality
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup KubeSolo
        id: kubesolo
        uses: ./
        with:
          version: 'latest'
          wait-for-ready: 'true'
          timeout: '120'
      
      - name: Verify KubeSolo is installed and running
        run: |
          echo "=== Verifying KubeSolo Installation ==="
          which kubesolo && echo "✓ KubeSolo binary found" || (echo "✗ KubeSolo binary not found" && exit 1)
          sudo systemctl is-active kubesolo && echo "✓ KubeSolo service is active" || (echo "✗ KubeSolo service not active" && exit 1)
          echo "✓ KubeSolo is installed and running"
      
      - name: Verify KUBECONFIG environment variable
        run: |
          echo "=== Verifying KUBECONFIG ==="
          echo "KUBECONFIG output: ${{ steps.kubesolo.outputs.kubeconfig }}"
          echo "KUBECONFIG env var: $KUBECONFIG"
          test -n "$KUBECONFIG" && echo "✓ KUBECONFIG is set" || (echo "✗ KUBECONFIG not set" && exit 1)
          test -f "$KUBECONFIG" && echo "✓ kubeconfig file exists" || (echo "✗ kubeconfig file not found" && exit 1)
      
      - name: Test kubectl access
        run: |
          echo "=== Testing Kubernetes Functionality ==="
          kubectl version --client
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods -A
          echo "✓ kubectl can access the cluster"
          
      - name: Deploy test workload
        run: |
          echo "=== Deploying Test Workload ==="
          kubectl create deployment nginx --image=nginx:alpine
          kubectl wait --for=condition=available --timeout=60s deployment/nginx
          
          # Test connectivity
          POD_NAME=$(kubectl get pod -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD_NAME -- wget -O- http://localhost:80 | grep -q "Welcome to nginx"
          echo "✓ Workload is functioning correctly"
          
      - name: Verify cluster info
        run: |
          echo "=== Cluster Information ==="
          kubectl get nodes -o wide
          kubectl get pods -A -o wide
          echo "✓ All tests passed successfully!"