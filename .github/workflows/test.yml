name: Test Setup KubeSolo Action

on:
  push:
    branches:
      - main
      - javascript-action-with-cleanup
  pull_request:
  workflow_dispatch:

# Cancel in-progress runs for the same workflow on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-setup-and-cleanup:
    runs-on: ubuntu-24.04
    name: Test KubeSolo Setup and Cleanup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check initial state - Docker should be running
        run: |
          echo "=== Checking initial Docker state ==="
          systemctl is-active docker && echo "✓ Docker is active" || echo "✗ Docker is not active"
          which docker && echo "✓ Docker binary exists at: $(which docker)" || echo "✗ Docker binary not found"
          
      - name: Check initial state - containerd should be running
        run: |
          echo "=== Checking initial containerd state ==="
          systemctl is-active containerd && echo "✓ containerd is active" || echo "✗ containerd is not active"
          which containerd && echo "✓ containerd binary exists at: $(which containerd)" || echo "✗ containerd binary not found"
          
      - name: Setup KubeSolo
        id: kubesolo
        uses: ./
        with:
          version: 'latest'
          wait-for-ready: 'true'
          timeout: '120'
      
      - name: Verify KubeSolo is installed and running
        run: |
          echo "=== Verifying KubeSolo installation ==="
          which kubesolo && echo "✓ KubeSolo binary found at: $(which kubesolo)" || (echo "✗ KubeSolo binary not found" && exit 1)
          systemctl is-active kubesolo && echo "✓ KubeSolo service is active" || (echo "✗ KubeSolo service is not active" && exit 1)
          
      - name: Verify Docker is stopped and backed up
        run: |
          echo "=== Verifying Docker is disabled ==="
          if systemctl is-active docker; then
            echo "✗ Docker should be stopped but is still active"
            exit 1
          else
            echo "✓ Docker is stopped as expected"
          fi
          
          if [ -f /usr/bin/docker.bak ]; then
            echo "✓ Docker binary backup exists"
          else
            echo "✗ Docker binary backup not found"
            exit 1
          fi
          
      - name: Verify containerd is stopped and backed up
        run: |
          echo "=== Verifying containerd is disabled ==="
          if systemctl is-active containerd; then
            echo "✗ containerd should be stopped but is still active"
            exit 1
          else
            echo "✓ containerd is stopped as expected"
          fi
          
          if [ -f /usr/bin/containerd.bak ]; then
            echo "✓ containerd binary backup exists"
          else
            echo "✗ containerd binary backup not found"
            exit 1
          fi
      
      - name: Test kubectl access
        run: |
          echo "=== Testing kubectl access ==="
          export KUBECONFIG=${{ steps.kubesolo.outputs.kubeconfig }}
          kubectl version --client
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods -A
          
      - name: Deploy test workload
        run: |
          echo "=== Deploying test workload ==="
          export KUBECONFIG=${{ steps.kubesolo.outputs.kubeconfig }}
          
          # Create a simple nginx deployment
          kubectl create deployment nginx --image=nginx:alpine
          kubectl expose deployment nginx --port=80 --type=ClusterIP
          
          # Wait for deployment to be ready
          kubectl wait --for=condition=available --timeout=60s deployment/nginx
          
          # Verify deployment
          kubectl get deployments
          kubectl get pods
          kubectl get services
          
      - name: Test service connectivity
        run: |
          echo "=== Testing service connectivity ==="
          export KUBECONFIG=${{ steps.kubesolo.outputs.kubeconfig }}
          
          # Get the nginx pod name
          POD_NAME=$(kubectl get pod -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          echo "Testing pod: $POD_NAME"
          
          # Test connectivity
          kubectl exec $POD_NAME -- wget -O- http://localhost:80 | grep -q "Welcome to nginx"
          echo "✓ Service is responding correctly"
          
      # Note: Cleanup will run automatically in the "Post" phase after all steps complete
      # We'll verify the cleanup in a separate job
      
  # CRITICAL TEST: This job verifies system state restoration after cleanup
  # This is the most important test - it proves the action doesn't break subsequent workflows
  verify-system-restoration:
    runs-on: ubuntu-24.04
    name: Verify System State Restoration After Cleanup
    needs: test-setup-and-cleanup
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Record initial system state
        id: initial_state
        run: |
          echo "=== Recording Initial System State ==="
          
          # Check Docker
          if systemctl is-active docker >/dev/null 2>&1; then
            echo "docker_was_active=true" >> $GITHUB_OUTPUT
            echo "✓ Docker is initially active"
          else
            echo "docker_was_active=false" >> $GITHUB_OUTPUT
            echo "✗ Docker is initially inactive"
          fi
          
          # Check containerd
          if systemctl is-active containerd >/dev/null 2>&1; then
            echo "containerd_was_active=true" >> $GITHUB_OUTPUT
            echo "✓ containerd is initially active"
          else
            echo "containerd_was_active=false" >> $GITHUB_OUTPUT
            echo "✗ containerd is initially inactive"
          fi
          
          # Test Docker functionality
          if docker ps >/dev/null 2>&1; then
            echo "docker_ps_worked=true" >> $GITHUB_OUTPUT
            echo "✓ 'docker ps' works initially"
          else
            echo "docker_ps_worked=false" >> $GITHUB_OUTPUT
            echo "✗ 'docker ps' does not work initially"
          fi
          
          # List binary locations
          echo "Docker binary: $(which docker 2>/dev/null || echo 'not found')"
          echo "containerd binary: $(which containerd 2>/dev/null || echo 'not found')"
        
      - name: Setup KubeSolo
        id: kubesolo
        uses: ./
        with:
          version: 'latest'
          timeout: '120'
        
      - name: Verify KubeSolo works
        run: |
          echo "=== Testing KubeSolo Functionality ==="
          export KUBECONFIG=${{ steps.kubesolo.outputs.kubeconfig }}
          kubectl get nodes
          kubectl get pods -A
          echo "✓ KubeSolo is working"
        
      - name: Verify Docker is disabled during KubeSolo usage
        run: |
          echo "=== Verifying Docker is disabled ==="
          if systemctl is-active docker >/dev/null 2>&1; then
            echo "✗ ERROR: Docker should be stopped but is still active"
            exit 1
          fi
          echo "✓ Docker is stopped as expected"
          
          if [ -f /usr/bin/docker.bak ]; then
            echo "✓ Docker binary backup exists"
          else
            echo "✗ ERROR: Docker binary backup not found"
            exit 1
          fi
        
      # Cleanup runs automatically here via post: hook
      
      - name: Wait for cleanup to complete
        if: always()
        run: |
          echo "Cleanup runs automatically via GitHub Actions post: hook"
          echo "Waiting a moment to ensure cleanup completes..."
          sleep 5
        
      - name: CRITICAL TEST - Verify Docker is restored and functional
        if: always()
        run: |
          echo "=== CRITICAL: Verifying Docker Restoration ==="
          
          # Check if Docker service is active again
          if ! systemctl is-active docker >/dev/null 2>&1; then
            echo "✗ FAIL: Docker service is not active after cleanup"
            systemctl status docker || true
            exit 1
          fi
          echo "✓ Docker service is active"
          
          # Check if Docker binary is restored
          if ! which docker >/dev/null 2>&1; then
            echo "✗ FAIL: Docker binary not found after cleanup"
            ls -la /usr/bin/docker* || true
            exit 1
          fi
          echo "✓ Docker binary exists at: $(which docker)"
          
          # MOST IMPORTANT: Verify Docker actually works
          if ! docker ps >/dev/null 2>&1; then
            echo "✗ FAIL: 'docker ps' does not work after cleanup"
            docker ps || true
            exit 1
          fi
          echo "✓ 'docker ps' works after cleanup"
          
          # Try running a container to prove Docker is fully functional
          if ! docker run --rm hello-world >/dev/null 2>&1; then
            echo "✗ FAIL: Cannot run Docker containers after cleanup"
            docker run --rm hello-world || true
            exit 1
          fi
          echo "✓ Docker can run containers after cleanup"
          
          echo ""
          echo "=========================================="
          echo "✓✓✓ DOCKER IS FULLY FUNCTIONAL AFTER CLEANUP ✓✓✓"
          echo "=========================================="
        
      - name: CRITICAL TEST - Verify containerd is restored
        if: always()
        run: |
          echo "=== CRITICAL: Verifying containerd Restoration ==="
          
          # Check if containerd service is active
          if ! systemctl is-active containerd >/dev/null 2>&1; then
            echo "✗ FAIL: containerd service is not active after cleanup"
            systemctl status containerd || true
            exit 1
          fi
          echo "✓ containerd service is active"
          
          # Check if containerd binary is restored
          if ! which containerd >/dev/null 2>&1; then
            echo "✗ FAIL: containerd binary not found after cleanup"
            ls -la /usr/bin/containerd* || true
            exit 1
          fi
          echo "✓ containerd binary exists at: $(which containerd)"
          
          echo ""
          echo "=========================================="
          echo "✓✓✓ CONTAINERD IS RESTORED AFTER CLEANUP ✓✓✓"
          echo "=========================================="
        
      - name: CRITICAL TEST - Verify no KubeSolo remnants
        if: always()
        run: |
          echo "=== CRITICAL: Verifying Complete Cleanup ==="
          
          # Check KubeSolo binary is removed
          if [ -f /usr/local/bin/kubesolo ]; then
            echo "✗ FAIL: KubeSolo binary still exists"
            exit 1
          fi
          echo "✓ KubeSolo binary removed"
          
          # Check KubeSolo data directory is removed
          if [ -d /var/lib/kubesolo ]; then
            echo "✗ FAIL: KubeSolo data directory still exists"
            ls -la /var/lib/kubesolo || true
            exit 1
          fi
          echo "✓ KubeSolo data directory removed"
          
          # Check KubeSolo service is removed
          if [ -f /etc/systemd/system/kubesolo.service ]; then
            echo "✗ FAIL: KubeSolo service file still exists"
            exit 1
          fi
          echo "✓ KubeSolo service file removed"
          
          # Check for any .bak files that should have been restored
          if ls /usr/bin/*.bak >/dev/null 2>&1; then
            echo "✗ FAIL: Backup files still exist:"
            ls -la /usr/bin/*.bak
            exit 1
          fi
          echo "✓ No backup files remaining"
          
          echo ""
          echo "=========================================="
          echo "✓✓✓ SYSTEM COMPLETELY CLEANED UP ✓✓✓"
          echo "=========================================="
        
      - name: FINAL TEST - Run a Docker workflow to prove system is usable
        if: always()
        run: |
          echo "=== FINAL TEST: Running Docker Workflow ==="
          echo "This simulates a subsequent workflow that needs Docker"
          
          # Pull an image
          docker pull nginx:alpine
          
          # Run a container
          CONTAINER_ID=$(docker run -d -p 8080:80 nginx:alpine)
          echo "Started container: $CONTAINER_ID"
          
          # Wait for it to be ready
          sleep 3
          
          # Test it responds
          curl -f http://localhost:8080 >/dev/null 2>&1 || (echo "✗ Container not responding" && exit 1)
          
          # Clean up
          docker stop $CONTAINER_ID
          docker rm $CONTAINER_ID
          
          echo ""
          echo "=========================================="
          echo "✓✓✓ SUBSEQUENT DOCKER WORKFLOWS WORK ✓✓✓"
          echo "=========================================="
          echo ""
          echo "SUCCESS: System state has been completely restored!"
          echo "Docker and containerd work exactly as they did before."