name: Test Setup KubeSolo Action

on:
  push:
    branches:
      - main
      - javascript-action-with-cleanup
  pull_request:
  workflow_dispatch:

# Prevent concurrent test runs on the same runner
concurrency:
  group: kubesolo-test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Basic functionality test - setup, use KubeSolo, cleanup runs automatically
  test-kubesolo-functionality:
    runs-on: self-hosted
    name: Test KubeSolo Functionality
    outputs:
      docker-was-installed: ${{ steps.check-initial.outputs.docker-installed }}
      containerd-was-installed: ${{ steps.check-initial.outputs.containerd-installed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check initial state
        id: check-initial
        run: |
          echo "=== Checking Initial System State ==="
          
          # Check Docker
          if systemctl is-active docker >/dev/null 2>&1; then
            echo "✓ Docker is active"
            echo "docker-installed=true" >> $GITHUB_OUTPUT
          else
            echo "✗ Docker is not active"
            echo "docker-installed=false" >> $GITHUB_OUTPUT
          fi
          
          # Check containerd
          if systemctl is-active containerd >/dev/null 2>&1; then
            echo "✓ containerd is active"
            echo "containerd-installed=true" >> $GITHUB_OUTPUT
          else
            echo "✗ containerd is not active"
            echo "containerd-installed=false" >> $GITHUB_OUTPUT
          fi
          
          # Check Docker binary
          if which docker >/dev/null 2>&1; then
            echo "✓ Docker binary: $(which docker)"
          else
            echo "✗ Docker not found"
          fi
          
          # Check containerd binary
          if which containerd >/dev/null 2>&1; then
            echo "✓ containerd binary: $(which containerd)"
          else
            echo "✗ containerd not found"
          fi
          
      - name: Setup KubeSolo
        id: kubesolo
        uses: ./
        with:
          version: 'latest'
          wait-for-ready: 'true'
          timeout: '120'
      
      - name: Verify KubeSolo is installed and running
        run: |
          echo "=== Verifying KubeSolo Installation ==="
          which kubesolo && echo "✓ KubeSolo binary found" || (echo "✗ KubeSolo binary not found" && exit 1)
          systemctl is-active kubesolo && echo "✓ KubeSolo service is active" || (echo "✗ KubeSolo service not active" && exit 1)
          
      - name: Verify container runtimes are disabled
        run: |
          echo "=== Verifying Container Runtimes Are Disabled ==="
          
          # Container runtime services should NOT be active (stopped or masked)
          if systemctl is-active docker >/dev/null 2>&1; then
            echo "✗ Docker should be stopped but is still active"
            exit 1
          fi
          echo "✓ Docker service is not active (stopped or masked)"
          
          if systemctl is-active containerd >/dev/null 2>&1; then
            echo "✗ containerd should be stopped but is still active"
            exit 1
          fi
          echo "✓ containerd service is not active (stopped or masked)"
          
          # Only check for backups if binaries were originally present
          # The action only backs up binaries that exist
          echo ""
          echo "Checking binary backups (conditional on original presence)..."
          
          # Docker binary check
          if [ -f /usr/bin/docker.bak ]; then
            echo "✓ Docker binary was backed up to /usr/bin/docker.bak"
          elif [ ! -f /usr/bin/docker ]; then
            echo "ℹ Docker binary was not installed originally, no backup expected"
          else
            echo "✗ Docker binary exists but was not backed up"
            exit 1
          fi
          
          # containerd binary check
          if [ -f /usr/bin/containerd.bak ]; then
            echo "✓ containerd binary was backed up to /usr/bin/containerd.bak"
          elif [ ! -f /usr/bin/containerd ]; then
            echo "ℹ containerd binary was not installed originally, no backup expected"
          else
            echo "✗ containerd binary exists but was not backed up"
            exit 1
          fi
      
      - name: Test kubectl access
        run: |
          echo "=== Testing Kubernetes Functionality ==="
          export KUBECONFIG=${{ steps.kubesolo.outputs.kubeconfig }}
          kubectl version --client
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods -A
          
      - name: Deploy test workload
        run: |
          echo "=== Deploying Test Workload ==="
          export KUBECONFIG=${{ steps.kubesolo.outputs.kubeconfig }}
          
          kubectl create deployment nginx --image=nginx:alpine
          kubectl expose deployment nginx --port=80 --type=ClusterIP
          kubectl wait --for=condition=available --timeout=60s deployment/nginx
          
          # Test connectivity
          POD_NAME=$(kubectl get pod -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD_NAME -- wget -O- http://localhost:80 | grep -q "Welcome to nginx"
          echo "✓ Workload is functioning correctly"
          
      # NOTE: Cleanup runs automatically via post: hook after this job completes
      
  # Job 2: CRITICAL TEST - Verify cleanup worked by running the action again
  # This simulates a realistic scenario: a subsequent workflow that also needs KubeSolo
  # If cleanup didn't work, this job would fail because Docker/containerd would still be masked
  test-cleanup-restoration:
    runs-on: self-hosted
    name: Verify Cleanup Restores System State
    needs: test-kubesolo-functionality
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Verify system state restoration
        env:
          DOCKER_WAS_INSTALLED: ${{ needs.test-kubesolo-functionality.outputs.docker-was-installed }}
          CONTAINERD_WAS_INSTALLED: ${{ needs.test-kubesolo-functionality.outputs.containerd-was-installed }}
        run: |
          echo "=== CRITICAL TEST: Verifying System State Was Restored ==="
          echo "This proves cleanup from the previous job restored the system properly"
          echo ""
          echo "Initial system state:"
          echo "  - Docker was installed: $DOCKER_WAS_INSTALLED"
          echo "  - containerd was installed: $CONTAINERD_WAS_INSTALLED"
          echo ""
          
          # Only test Docker if it was originally installed
          if [ "$DOCKER_WAS_INSTALLED" = "true" ]; then
            echo "Testing Docker restoration (was originally installed)..."
            
            # If cleanup didn't work, Docker would still be masked and this would fail
            if ! systemctl is-active docker >/dev/null 2>&1; then
              echo "✗ CRITICAL FAILURE: Docker is not active"
              echo "This means the previous job's cleanup did NOT restore Docker!"
              systemctl status docker || true
              exit 1
            fi
            echo "✓ Docker service is active"
            
            # Verify Docker actually works
            if ! docker ps >/dev/null 2>&1; then
              echo "✗ CRITICAL FAILURE: 'docker ps' does not work"
              echo "This means the previous job's cleanup did NOT properly restore Docker!"
              docker ps || true
              exit 1
            fi
            echo "✓ 'docker ps' works"
            
            # Try running a container
            if ! docker run --rm hello-world 2>&1 | grep -q "Hello from Docker"; then
              echo "✗ CRITICAL FAILURE: Cannot run Docker containers"
              echo "This means the previous job's cleanup did NOT properly restore Docker!"
              exit 1
            fi
            echo "✓ Docker can run containers"
            
            echo ""
            echo "=========================================="
            echo "✓✓✓ SUCCESS: CLEANUP RESTORED DOCKER ✓✓✓"
            echo "=========================================="
          else
            echo "ℹ Docker was not installed originally - skipping Docker tests"
            echo "✓ This is expected behavior for systems without Docker"
          fi
          
          echo ""
          
          # Only test containerd if it was originally installed
          if [ "$CONTAINERD_WAS_INSTALLED" = "true" ]; then
            echo "Testing containerd restoration (was originally installed)..."
            
            if ! systemctl is-active containerd >/dev/null 2>&1; then
              echo "✗ CRITICAL FAILURE: containerd is not active"
              echo "This means the previous job's cleanup did NOT restore containerd!"
              systemctl status containerd || true
              exit 1
            fi
            echo "✓ containerd service is active"
            
            if ! which containerd >/dev/null; then
              echo "✗ containerd binary missing"
              exit 1
            fi
            echo "✓ containerd binary exists"
            
            echo ""
            echo "=============================================="
            echo "✓✓✓ SUCCESS: CLEANUP RESTORED CONTAINERD ✓✓✓"
            echo "=============================================="
          else
            echo "ℹ containerd was not installed originally - skipping containerd tests"
            echo "✓ This is expected behavior for systems without containerd"
          fi
          
      - name: Verify no KubeSolo remnants from previous job
        run: |
          echo "=== Verifying Previous Cleanup Was Complete ==="
          
          [ ! -f /usr/local/bin/kubesolo ] && echo "✓ KubeSolo binary removed" || (echo "✗ KubeSolo binary still exists" && exit 1)
          [ ! -d /var/lib/kubesolo ] && echo "✓ KubeSolo data dir removed" || (echo "✗ KubeSolo data dir still exists" && exit 1)
          [ ! -f /etc/systemd/system/kubesolo.service ] && echo "✓ KubeSolo service removed" || (echo "✗ KubeSolo service file still exists" && exit 1)
          
          # No backup files should remain
          if ls /usr/bin/*.bak >/dev/null 2>&1; then
            echo "✗ Backup files still exist:"
            ls -la /usr/bin/*.bak
            exit 1
          fi
          echo "✓ No backup files remaining"
          
          # CRITICAL: Verify port 6443 is NOT in use
          # This is essential for other k8s distributions to work after KubeSolo
          echo ""
          echo "=== CRITICAL: Verifying Port 6443 Is Available ==="
          if ss -tlnp 2>/dev/null | grep -q ":6443 "; then
            echo "✗ CRITICAL FAILURE: Port 6443 is still in use!"
            echo "This will prevent other k8s distributions from starting."
            echo "Processes using port 6443:"
            ss -tlnp 2>/dev/null | grep ":6443"
            exit 1
          fi
          echo "✓ Port 6443 is free and available for other k8s distributions"
          
      - name: Run KubeSolo again to prove it works after cleanup
        id: kubesolo
        uses: ./
        with:
          version: 'latest'
          timeout: '120'
        
      - name: Verify second KubeSolo instance works
        run: |
          echo "=== Verifying Second KubeSolo Installation Works ==="
          export KUBECONFIG=${{ steps.kubesolo.outputs.kubeconfig }}
          kubectl get nodes
          kubectl get pods -A
          kubectl create deployment nginx --image=nginx:alpine
          kubectl wait --for=condition=available --timeout=60s deployment/nginx
          echo "✓ Second KubeSolo instance is fully functional"
          
      # Cleanup will run automatically again for this job
      
  # Job 3: FINAL TEST - Run a pure Docker workflow after everything
  # This proves the action can be used multiple times without breaking the system
  test-docker-after-multiple-runs:
    runs-on: self-hosted
    name: Verify Docker Works After Multiple KubeSolo Runs
    needs: [test-kubesolo-functionality, test-cleanup-restoration]
    if: always()
    steps:
      - name: FINAL TEST - Verify Docker is fully functional
        env:
          DOCKER_WAS_INSTALLED: ${{ needs.test-kubesolo-functionality.outputs.docker-was-installed }}
        run: |
          echo "=== FINAL TEST: Docker After Multiple KubeSolo Runs ==="
          echo "This simulates a workflow that needs Docker after KubeSolo has been used"
          echo ""
          echo "Initial system state: Docker was installed = $DOCKER_WAS_INSTALLED"
          echo ""
          
          if [ "$DOCKER_WAS_INSTALLED" = "true" ]; then
            echo "Running Docker tests (Docker was originally installed)..."
            
            # Check Docker service
            if ! systemctl is-active docker >/dev/null 2>&1; then
              echo "✗ FAIL: Docker service not active"
              systemctl status docker || true
              exit 1
            fi
            echo "✓ Docker service is active"
            
            # Pull and run a container
            echo "Pulling nginx:alpine..."
            docker pull nginx:alpine
            
            echo "Running container..."
            CONTAINER_ID=$(docker run -d -p 8080:80 nginx:alpine)
            echo "Started container: $CONTAINER_ID"
            
            # Wait and test
            sleep 3
            curl -f http://localhost:8080 >/dev/null 2>&1 || (echo "✗ Container not responding" && exit 1)
            echo "✓ Container is responding"
            
            # Cleanup
            docker stop $CONTAINER_ID >/dev/null
            docker rm $CONTAINER_ID >/dev/null
            
            echo ""
            echo "=========================================="
            echo "✓✓✓ COMPLETE SUCCESS ✓✓✓"
            echo "=========================================="
            echo ""
            echo "The setup-kubesolo action:"
            echo "  ✓ Installs and runs KubeSolo successfully"
            echo "  ✓ Properly disables Docker/containerd during use"
            echo "  ✓ Completely restores system state after cleanup"
            echo "  ✓ Can be run multiple times without issues"
            echo "  ✓ Allows subsequent workflows to use Docker normally"
            echo ""
            echo "System state restoration is PERFECT!"
          else
            echo "=========================================="
            echo "✓✓✓ TESTS COMPLETE ✓✓✓"
            echo "=========================================="
            echo ""
            echo "Docker was not originally installed on this system."
            echo "This is a valid configuration. Test results:"
            echo ""
            echo "The setup-kubesolo action:"
            echo "  ✓ Installs and runs KubeSolo successfully"
            echo "  ✓ Works correctly on systems without Docker/containerd"
            echo "  ✓ Only backs up/restores what was originally present"
            echo "  ✓ Can be run multiple times without issues"
            echo "  ✓ Leaves system in original state after cleanup"
            echo ""
            echo "System state restoration is PERFECT!"
            echo "(Skipped Docker container tests - not applicable)"
          fi