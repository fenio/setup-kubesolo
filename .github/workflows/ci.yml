name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-kubesolo-functionality:
    runs-on: ubuntu-latest
    name: Test KubeSolo Functionality
    
    steps:
      - uses: actions/checkout@v6

      - name: Debug iptables before cleanup
        run: |
          echo "=== iptables filter table ==="
          sudo iptables -L -n -v
          echo ""
          echo "=== iptables nat table ==="
          sudo iptables -t nat -L -n -v
          echo ""
          echo "=== iptables mangle table ==="
          sudo iptables -t mangle -L -n -v
          echo ""
          echo "=== iptables raw table ==="
          sudo iptables -t raw -L -n -v
          echo ""
          echo "=== Network interfaces ==="
          ip link show
          echo ""
          echo "=== Docker/container processes ==="
          ps aux | grep -E 'docker|containerd|podman' || echo "No container processes found"

      - name: Install KubeSolo
        uses: ./
        with:
          wait-for-ready: 'true'
          timeout: '120'

      - name: Debug iptables after KubeSolo installation
        run: |
          echo "=== iptables filter table ==="
          sudo iptables -L -n -v
          echo ""
          echo "=== iptables nat table ==="
          sudo iptables -t nat -L -n -v
          echo ""
          echo "=== iptables mangle table ==="
          sudo iptables -t mangle -L -n -v
          echo ""
          echo "=== iptables raw table ==="
          sudo iptables -t raw -L -n -v
          echo ""
          echo "=== Network interfaces ==="
          ip link show
          echo ""
          echo "=== KubeSolo/container processes ==="
          ps aux | grep -E 'kubesolo|containerd|flannel|cni' || echo "No relevant processes found"

      - name: Test kubectl access
        run: |
          export KUBECONFIG=/var/lib/kubesolo/pki/admin/admin.kubeconfig
          kubectl cluster-info
          kubectl get pods -A

      - name: Deploy and test workload
        run: |
          export KUBECONFIG=/var/lib/kubesolo/pki/admin/admin.kubeconfig
          
          kubectl create deployment nginx --image=nginx:alpine
          kubectl expose deployment nginx --port=80 --type=ClusterIP
          kubectl wait --for=condition=available --timeout=120s deployment/nginx
          
          POD_NAME=$(kubectl get pod -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD_NAME -- wget -O- http://localhost:80 | grep -q "Welcome to nginx"
          echo "✓ Workload test passed"

      - name: Test pod networking
        run: |
          export KUBECONFIG=/var/lib/kubesolo/pki/admin/admin.kubeconfig
          
          # Wait for CoreDNS
          for i in $(seq 1 30); do
            if kubectl get pods -n kube-system 2>/dev/null | grep -q "coredns.*1/1.*Running"; then
              echo "✓ CoreDNS ready"
              break
            fi
            sleep 2
          done
          
          kubectl run connectivity-test --image=busybox:stable --restart=Never -- sleep 300
          kubectl wait --for=condition=ready --timeout=60s pod/connectivity-test
          
          # Test DNS with retries
          for i in $(seq 1 10); do
            if kubectl exec connectivity-test -- nslookup google.com; then
              echo "✓ DNS working"
              break
            fi
            echo "DNS not ready yet, retrying... ($i/10)"
            sleep 2
          done
          
          # Test internet
          kubectl exec connectivity-test -- wget -q -O- --timeout=10 http://ifconfig.me && echo ""
          echo "✓ Internet connectivity working"
          
          kubectl delete pod connectivity-test --ignore-not-found
