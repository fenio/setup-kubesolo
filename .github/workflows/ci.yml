name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-kubesolo-functionality:
    runs-on: ubuntu-latest
    name: Test KubeSolo Functionality
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Remove conflicting container engines
        run: |
          echo "=== Removing Conflicting Container Engines ==="
          echo "KubeSolo requires no container engines to be installed or active"
          
          # Stop and disable Docker
          if systemctl is-active --quiet docker 2>/dev/null; then
            echo "Stopping Docker..."
            sudo systemctl stop docker docker.socket
            sudo systemctl disable docker docker.socket
          fi
          
          # Stop and disable containerd
          if systemctl is-active --quiet containerd 2>/dev/null; then
            echo "Stopping containerd..."
            sudo systemctl stop containerd
            sudo systemctl disable containerd
          fi
          
          # Stop and disable Podman if present
          if systemctl is-active --quiet podman 2>/dev/null; then
            echo "Stopping Podman..."
            sudo systemctl stop podman podman.socket
            sudo systemctl disable podman podman.socket
          fi
          
          echo "✓ Container engines stopped"

      - name: Check initial state
        run: |
          echo "=== Checking Initial System State ==="
          
          # Verify no container engines are running
          echo "Verifying no container engines are running..."
          RUNNING_ENGINES=""
          
          systemctl is-active --quiet docker 2>/dev/null && RUNNING_ENGINES="${RUNNING_ENGINES} docker"
          systemctl is-active --quiet containerd 2>/dev/null && RUNNING_ENGINES="${RUNNING_ENGINES} containerd"
          systemctl is-active --quiet podman 2>/dev/null && RUNNING_ENGINES="${RUNNING_ENGINES} podman"
          
          if [ -n "$RUNNING_ENGINES" ]; then
            echo "✗ Container engines still running:$RUNNING_ENGINES"
            exit 1
          fi
          echo "✓ No conflicting container engines running"
          
          # Check kubesolo not already installed
          ! which kubesolo && echo "✓ kubesolo not installed initially" || (echo "✗ kubesolo already installed" && exit 1)
          
      - name: Setup KubeSolo
        id: kubesolo
        uses: ./
        with:
          version: 'latest'
          wait-for-ready: 'true'
          timeout: '120'
      
      - name: Verify KubeSolo is installed and running
        run: |
          echo "=== Verifying KubeSolo Installation ==="
          which kubesolo && echo "✓ kubesolo binary found at $(which kubesolo)" || (echo "✗ kubesolo binary not found" && exit 1)
          sudo systemctl is-active kubesolo && echo "✓ kubesolo service is active" || (echo "✗ kubesolo service not active" && exit 1)
      
      - name: Test kubectl access
        env:
          KUBECONFIG: ${{ steps.kubesolo.outputs.kubeconfig }}
        run: |
          echo "=== Testing Kubernetes Functionality ==="
          kubectl version --client
          kubectl cluster-info
          kubectl get nodes -o wide
          kubectl get pods -A
          
      - name: Deploy test workload
        env:
          KUBECONFIG: ${{ steps.kubesolo.outputs.kubeconfig }}
        run: |
          echo "=== Deploying Test Workload ==="
          
          kubectl create deployment nginx --image=nginx:alpine
          kubectl expose deployment nginx --port=80 --type=ClusterIP
          kubectl wait --for=condition=available --timeout=120s deployment/nginx
          
          # Test connectivity
          POD_NAME=$(kubectl get pod -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD_NAME -- wget -O- http://localhost:80 | grep -q "Welcome to nginx"
          echo "✓ Workload is functioning correctly"
      
      - name: Test internet connectivity from pod
        env:
          KUBECONFIG: ${{ steps.kubesolo.outputs.kubeconfig }}
        run: |
          echo "=== Testing Internet Connectivity from Pod ==="
          
          # Wait for CoreDNS to be fully ready (1/1 Running)
          echo "Waiting for CoreDNS to be ready..."
          for i in $(seq 1 60); do
            POD_STATUS=$(kubectl get pods -n kube-system 2>/dev/null || true)
            echo "$POD_STATUS"
            if echo "$POD_STATUS" | grep -q "coredns.*1/1.*Running"; then
              echo "✓ CoreDNS is fully ready"
              # Give CoreDNS a few seconds to start accepting connections
              sleep 5
              break
            fi
            echo "Waiting for CoreDNS to be ready... ($i/60)"
            sleep 2
          done
          kubectl get pods -A
          
          kubectl run connectivity-test --image=busybox:stable --restart=Never -- sleep 300
          kubectl wait --for=condition=ready --timeout=60s pod/connectivity-test
          
          # Test DNS resolution with retries
          echo "Testing DNS resolution..."
          for i in $(seq 1 10); do
            if kubectl exec connectivity-test -- nslookup google.com; then
              echo "✓ DNS resolution working"
              break
            fi
            echo "DNS not ready yet, retrying... ($i/10)"
            sleep 2
          done
          
          # Test external connectivity
          kubectl exec connectivity-test -- wget -q -O- --timeout=10 http://ifconfig.me && echo ""
          echo "✓ Internet connectivity from pod is working"
          
          kubectl delete pod connectivity-test --ignore-not-found